{% extends 'base.html' %}

{% block title %}Admin{% endblock %}

{% block content %}
<div class="card" id="admin-page" data-api-jobs-url="/api/v1/admin/jobs">
    <div class="toolbar">
        <div class="hint">Run maintenance tasks.</div>
        <div><a class="button" href="/">Home</a></div>
    </div>

    {% if msg %}
    <p class="msg">{{ msg }}</p>
    {% endif %}

    <form method="POST" action="/admin/init-db" class="stack">
        <button type="submit">Initialize DB schema</button>
    </form>

    <form method="POST" action="/admin/recreate-db" class="stack"
        onsubmit="return window.confirm('This will DELETE data/sec.db and recreate an empty schema.\n\nType RECREATE in the box and click OK to proceed.');">
        <div class="warn">
            <strong>Warning:</strong> This deletes <code>data/sec.db</code> and recreates an empty DB.
            This cannot be undone.
        </div>
        <div class="row">
            <input class="confirm" name="confirm" placeholder="Type RECREATE to confirm" autocomplete="off" />
            <button class="danger" type="submit" {% if recreate_state.running %}disabled{% endif %}>
                Recreate SQLite DB (destructive)
            </button>
        </div>
    </form>

    <form method="POST" action="/admin" class="stack">
        <button type="submit" {% if state.running %}disabled{% endif %}>
            Start populate_daily_values
        </button>
    </form>

    <form method="POST" action="/admin/stop-populate" class="stack">
        <button type="submit" {% if not state.running %}disabled{% endif %}>
            Stop populate_daily_values
        </button>
    </form>

    <div class="kv" id="populate-job" data-job="populate_daily_values">
        <div class="k">Status</div>
        <div class="v"><span id="admin-populate-status" data-role="populate-status">{{ status }}</span></div>
        <div class="k">Started</div>
        <div class="v"><span id="admin-populate-started" data-role="populate-started">{{ started_at or '-' }}</span>
        </div>
        <div class="k">Ended</div>
        <div class="v"><span id="admin-populate-ended" data-role="populate-ended">{{ ended_at or '-' }}</span></div>
        <div class="k">Stop requested</div>
        <div class="v"><span id="admin-populate-stop" data-role="populate-stop">{{ 'YES' if state.stop_requested else
                'NO' }}</span></div>
        <div class="k">Last log line</div>
        <div class="v"><code id="admin-populate-log" data-role="populate-log">{{ esc(populate_last_log) }}</code></div>
    </div>

    <div class="kv" id="recreate-job" data-job="recreate_sqlite_db" style="margin-top: 1.25rem;">
        <div class="k">Recreate DB</div>
        <div class="v"><span id="admin-recreate-status" data-role="recreate-status">{{ recreate_status }}</span></div>
        <div class="k">Started</div>
        <div class="v"><span id="admin-recreate-started" data-role="recreate-started">{{ recreate_started_at or '-'
                }}</span></div>
        <div class="k">Ended</div>
        <div class="v"><span id="admin-recreate-ended" data-role="recreate-ended">{{ recreate_ended_at or '-' }}</span>
        </div>
        <div class="k">Last log line</div>
        <div class="v"><code id="admin-recreate-log" data-role="recreate-log">{{ esc(recreate_last_log) }}</code></div>
    </div>

    <div class="hint admin-polling" id="admin-polling-hint" aria-live="polite">
        Logs are written to <code>populate_daily_values.log</code>.
        <span class="admin-polling__status" id="admin-polling-status"></span>
    </div>

    {% if error %}
    <pre class="error" id="admin-populate-error" data-role="populate-error">{{ error }}</pre>
    {% endif %}

    {% if recreate_error %}
    <pre class="error" id="admin-recreate-error" data-role="recreate-error">{{ recreate_error }}</pre>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endblock %}